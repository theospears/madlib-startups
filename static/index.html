<html>
<head>
<link rel="stylesheet" type="text/css" href="/style.css" />
<script type="text/javascript" src="/jquery-1.7.1.min.js" ></script>
</head>
<body>
<div id="MeasureText"></div>
<p class="intro">I want to tell you about my cool new startup...</p>
<p class="description" id="description"></p>
<p class="clicktoedit">(Click on phrases above to make this idea better)</p>

<p class="see-more"><a href="#" id="see-more" onclick="javascript:set_description()">That's cool, are you involved in any other startups?</a></p>

<script type="text/javascript">

function random_element(arr) {
	return arr[Math.floor(Math.random()*arr.length)];
}

function fill_template(template, source) {
	var input = "";
	var result = template;
	while(result != input) {
		input = result;
		result = input.replace(/\$\w+/g, function(type) {
			var substitute = source[type.substring(1)];
			if(typeof substitute === 'undefined') {
				return type;
			} else if(Object.prototype.toString.call(substitute) === '[object Array]') {
				return '<span class="' + type.substring(1) + '">' + random_element(substitute) + '</span>';
			} else if(typeof substitute === 'function') {
				return substitute();
			}
		});
	}
	return result;
}

function set_description(items) {
	var description = fill_template(random_element(items['template']), items);
	document.getElementById('description').innerHTML = description;
	var words = document.getElementsByTagName('span');
	for(var i = 0; i < words.length; i++) {
		words[i].onclick = function() {
			var theSpan = this;
			theSpan.style.display = "none";
			var input = document.createElement('input');
			input.type = 'text';
			input.value = theSpan.innerText;
			input.style.width = measureText(theSpan.innerText);

			function hideEditor() {
				if(input.value !== '' && input.value !== theSpan.innerText) {
					theSpan.innerText = input.value;

					$.post("/phrases/" + theSpan.className, {
						'content': input.value
					});
				}
				theSpan.style.display = "inline";
				input.parentNode.removeChild(input);
			}
			input.onblur=hideEditor;
			input.onkeydown = function(ev) {
				if(ev.which == 13 || ev.keyCode == 13) {
					hideEditor();
				}
			};

			this.parentNode.insertBefore(input, theSpan);
			input.focus();
			input.select();
		};
	}
	return false;
}

function measureText(text)
{
	var test = document.getElementById("MeasureText");
	test.innerText = text;
	return (test.clientWidth + 1) + "px";
}

function set_description_from_server() {
	$.get('/template-data', function(data) {
		set_description(data);
	});
	return false;
}

$(function() {
	$('#see-more').click(set_description_from_server);
	set_description_from_server();

});
</script>
</body>
</html>
